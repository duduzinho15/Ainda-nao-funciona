#!/usr/bin/env python3
"""
API da Shopee Corrigida - Schema GraphQL Validado
Baseado nos erros recebidos e campos disponíveis
"""

import hashlib
import json
import time
import requests
import logging
from typing import List, Dict, Any

# Configuração de logging
logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


class ShopeeAPICorrected:
    """API da Shopee com schema GraphQL corrigido"""

    def __init__(self, app_id: str, app_secret: str):
        self.app_id = app_id
        self.app_secret = app_secret
        self.base_url = "https://open-api.affiliate.shopee.com.br/graphql"

    def _generate_signature(self, timestamp: int, payload: str) -> str:
        """Gera assinatura SHA256 no formato que funciona"""
        factor = str(self.app_id) + str(timestamp) + payload + self.app_secret
        signature = hashlib.sha256(factor.encode()).hexdigest()
        return signature

    def get_product_offers(
        self, page: int = 0, limit: int = 50, list_type: int = 0, sort_type: int = 2
    ) -> List[Dict[str, Any]]:
        """Busca ofertas de produtos com schema corrigido"""

        # Schema corrigido baseado nos erros recebidos
        query = """query Fetch($page: Int, $limit: Int, $listType: Int, $sortType: Int) {
            productOfferV2(
                listType: $listType,
                sortType: $sortType,
                page: $page,
                limit: $limit
            ) {
                nodes {
                    commissionRate
                    commission
                    price
                    productLink
                    offerLink
                    ratingStar
                    shopName
                }
                pageInfo {
                    page
                    limit
                    hasNextPage
                }
            }
        }"""

        # Formata query
        formatted_query = query.replace("\n", "").strip()

        # Prepara payload
        payload = {
            "query": formatted_query,
            "variables": {
                "page": page,
                "limit": limit,
                "listType": list_type,
                "sortType": sort_type,
            },
        }

        payload_str = json.dumps(payload, separators=(",", ":"))
        timestamp = int(time.time())
        signature = self._generate_signature(timestamp, payload_str)

        # Headers corretos
        headers = {
            "Content-type": "application/json",
            "Authorization": f"SHA256 Credential={self.app_id},Timestamp={timestamp},Signature={signature}",
        }

        logger.info(f"🔍 Buscando {limit} ofertas (página {page})")

        try:
            response = requests.post(
                self.base_url, data=payload_str, headers=headers, timeout=30
            )

            if response.status_code == 200:
                result = response.json()

                if "data" in result and "productOfferV2" in result["data"]:
                    products = result["data"]["productOfferV2"]["nodes"]
                    logger.info(f"✅ {len(products)} produtos encontrados!")
                    return products
                else:
                    logger.warning("⚠️ Resposta inesperada da API")
                    if "errors" in result:
                        logger.error("📋 Erros encontrados:")
                        for error in result["errors"]:
                            logger.error(
                                f"   ❌ {error.get('message', 'Erro desconhecido')}"
                            )
                    return []
            else:
                logger.error(f"❌ Erro HTTP {response.status_code}")
                return []

        except Exception as e:
            logger.error(f"❌ Erro na requisição: {e}")
            return []

    def test_connection(self) -> bool:
        """Testa conexão com a API"""
        try:
            logger.info("🧪 Testando conexão com a API da Shopee...")

            offers = self.get_product_offers(page=0, limit=5)

            if offers and len(offers) > 0:
                logger.info("✅ Conexão com a API da Shopee funcionando!")
                return True
            else:
                logger.warning("⚠️ Conexão funcionando mas nenhum produto retornado")
                return False

        except Exception as e:
            logger.error(f"❌ Falha na conexão com a API da Shopee: {e}")
            return False


def main():
    """Função principal para teste"""
    print("🚀 TESTE DA API CORRIGIDA DA SHOPEE")
    print("=" * 50)

    # Credenciais que funcionaram
    app_id = "18330800803"
    app_secret = "IOMXMSUM5KDOLSYKXQERKCU42SNMJERR"

    print("✅ Usando credenciais:")
    print(f"   🆔 App ID: {app_id}")
    print(f"   🔐 App Secret: {app_secret[:10]}...{app_secret[-10:]}")

    # Cria instância da API
    api = ShopeeAPICorrected(app_id, app_secret)

    try:
        # Testa conexão
        print("\n🧪 Testando conexão...")
        if not api.test_connection():
            print("❌ Falha na conexão")
            return

        # Testa busca de ofertas
        print("\n🔍 Testando busca de ofertas...")
        offers = api.get_product_offers(page=0, limit=10, sort_type=5)

        if offers:
            print(f"✅ {len(offers)} ofertas encontradas!")

            for i, product in enumerate(offers[:3], 1):
                print(f"\n{i}. Produto encontrado:")
                print(f"   💰 Preço: R$ {product.get('price', 'N/A')}")
                print(f"   💸 Comissão: R$ {product.get('commission', 'N/A')}")
                print(f"   📊 Taxa: {product.get('commissionRate', 'N/A')}%")
                print(f"   ⭐ Avaliação: {product.get('ratingStar', 'N/A')}")
                print(f"   🏪 Loja: {product.get('shopName', 'N/A')}")
                print(
                    f"   🔗 Link do Produto: {product.get('productLink', 'N/A')[:50]}..."
                )
                print(
                    f"   🎯 Link da Oferta: {product.get('offerLink', 'N/A')[:50]}..."
                )
        else:
            print("⚠️ Nenhuma oferta encontrada")

        print("\n🎉 Teste concluído!")

    except Exception as e:
        print(f"❌ Erro durante o teste: {e}")


if __name__ == "__main__":
    main()
