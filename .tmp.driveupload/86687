#!/usr/bin/env python3
"""
API da Shopee com Schema Corrigido - Baseado nos erros recebidos
"""

import requests
import time
import hashlib
import json
from typing import List, Dict, Any


class ShopeeAPICorrectedSchema:
    """API da Shopee com schema GraphQL correto"""

    def __init__(self, app_id: str, app_secret: str):
        self.app_id = app_id
        self.app_secret = app_secret
        self.base_url = "https://open-api.affiliate.shopee.com.br/graphql"

    def _generate_signature(self, timestamp: int, payload: str) -> str:
        """Gera assinatura SHA256 no formato que funciona"""
        factor = str(self.app_id) + str(timestamp) + payload + self.app_secret
        signature = hashlib.sha256(factor.encode()).hexdigest()
        return signature

    def get_product_offers(
        self, page: int = 0, limit: int = 50, list_type: int = 0, sort_type: int = 2
    ) -> List[Dict[str, Any]]:
        """Busca ofertas de produtos com schema correto"""

        # Schema corrigido baseado nos erros recebidos
        query = """query Fetch($page: Int, $limit: Int, $listType: Int, $sortType: Int) {
            productOfferV2(
                listType: $listType,
                sortType: $sortType,
                page: $page,
                limit: $limit
            ) {
                nodes {
                    commissionRate
                    commission
                    price
                    productLink
                    offerLink
                    ratingStar
                    shopName
                }
                pageInfo {
                    page
                    limit
                    hasNextPage
                }
            }
        }"""

        # Formata query
        formatted_query = query.replace("\n", "").strip()

        # Prepara payload
        payload = {
            "query": formatted_query,
            "variables": {
                "page": page,
                "limit": limit,
                "listType": list_type,
                "sortType": sort_type,
            },
        }

        payload_str = json.dumps(payload, separators=(",", ":"))
        timestamp = int(time.time())
        signature = self._generate_signature(timestamp, payload_str)

        # Headers corretos
        headers = {
            "Content-type": "application/json",
            "Authorization": f"SHA256 Credential={self.app_id},Timestamp={timestamp},Signature={signature}",
        }

        print(f"ğŸ” Buscando {limit} ofertas (pÃ¡gina {page})")

        try:
            response = requests.post(
                self.base_url, data=payload_str, headers=headers, timeout=30
            )

            if response.status_code == 200:
                result = response.json()

                if "data" in result and "productOfferV2" in result["data"]:
                    products = result["data"]["productOfferV2"]["nodes"]
                    print(f"âœ… {len(products)} produtos encontrados!")
                    return products
                else:
                    print("âš ï¸ Resposta inesperada da API")
                    if "errors" in result:
                        print("ğŸ“‹ Erros encontrados:")
                        for error in result["errors"]:
                            print(f"   âŒ {error.get('message', 'Erro desconhecido')}")
                    return []
            else:
                print(f"âŒ Erro HTTP {response.status_code}")
                return []

        except Exception as e:
            print(f"âŒ Erro na requisiÃ§Ã£o: {e}")
            return []

    def get_schema_info(self) -> Dict[str, Any]:
        """Busca informaÃ§Ãµes do schema da API"""

        query = """query IntrospectionQuery {
            __schema {
                types {
                    name
                    description
                    fields {
                        name
                        description
                        type {
                            name
                            kind
                        }
                    }
                }
            }
        }"""

        # Formata query
        formatted_query = query.replace("\n", "").strip()

        # Prepara payload
        payload = {"query": formatted_query}

        payload_str = json.dumps(payload, separators=(",", ":"))
        timestamp = int(time.time())
        signature = self._generate_signature(timestamp, payload_str)

        # Headers corretos
        headers = {
            "Content-type": "application/json",
            "Authorization": f"SHA256 Credential={self.app_id},Timestamp={timestamp},Signature={signature}",
        }

        print("ğŸ” Buscando informaÃ§Ãµes do schema...")

        try:
            response = requests.post(
                self.base_url, data=payload_str, headers=headers, timeout=30
            )

            if response.status_code == 200:
                result = response.json()

                if "data" in result and "__schema" in result["data"]:
                    print("âœ… Schema obtido com sucesso!")
                    return result
                else:
                    print("âš ï¸ Resposta inesperada do schema")
                    if "errors" in result:
                        print("ğŸ“‹ Erros encontrados:")
                        for error in result["errors"]:
                            print(f"   âŒ {error.get('message', 'Erro desconhecido')}")
                    return {}
            else:
                print(f"âŒ Erro HTTP {response.status_code}")
                return {}

        except Exception as e:
            print(f"âŒ Erro ao buscar schema: {e}")
            return {}

    def test_simple_query(self) -> List[Dict[str, Any]]:
        """Testa query simples que sabemos que funciona"""

        # Query baseada no cÃ³digo que funcionou
        query = """query Fetch($page: Int) {
            productOfferV2(
                listType: 0,
                sortType: 2,
                page: $page,
                limit: 50
            ) {
                nodes {
                    commissionRate
                    commission
                    price
                    productLink
                    offerLink
                }
                pageInfo {
                    page
                    limit
                    hasNextPage
                }
            }
        }"""

        # Formata query
        formatted_query = query.replace("\n", "").strip()

        # Prepara payload
        payload = {"query": formatted_query, "variables": {"page": 0}}

        payload_str = json.dumps(payload, separators=(",", ":"))
        timestamp = int(time.time())
        signature = self._generate_signature(timestamp, payload_str)

        # Headers corretos
        headers = {
            "Content-type": "application/json",
            "Authorization": f"SHA256 Credential={self.app_id},Timestamp={timestamp},Signature={signature}",
        }

        print("ğŸ” Testando query simples...")

        try:
            response = requests.post(
                self.base_url, data=payload_str, headers=headers, timeout=30
            )

            if response.status_code == 200:
                result = response.json()

                if "data" in result and "productOfferV2" in result["data"]:
                    products = result["data"]["productOfferV2"]["nodes"]
                    print(f"âœ… {len(products)} produtos encontrados com query simples!")
                    return products
                else:
                    print("âš ï¸ Resposta inesperada da query simples")
                    if "errors" in result:
                        print("ğŸ“‹ Erros encontrados:")
                        for error in result["errors"]:
                            print(f"   âŒ {error.get('message', 'Erro desconhecido')}")
                    return []
            else:
                print(f"âŒ Erro HTTP {response.status_code}")
                return []

        except Exception as e:
            print(f"âŒ Erro na query simples: {e}")
            return []


def main():
    """FunÃ§Ã£o principal para teste"""
    print("ğŸš€ TESTE DA API DA SHOPEE - SCHEMA CORRIGIDO")
    print("=" * 60)

    # Credenciais que funcionaram
    app_id = "18330800803"
    app_secret = "IOMXMSUM5KDOLSYKXQERKCU42SNMJERR"

    print("âœ… Usando credenciais:")
    print(f"   ğŸ†” App ID: {app_id}")
    print(f"   ğŸ” App Secret: {app_secret[:10]}...{app_secret[-10:]}")

    # Cria instÃ¢ncia da API
    api = ShopeeAPICorrectedSchema(app_id, app_secret)

    try:
        # Teste 1: Query simples que sabemos que funciona
        print("\nğŸ§ª TESTE 1: Query Simples (Baseada no cÃ³digo que funcionou)")
        print("-" * 60)
        simple_offers = api.test_simple_query()

        if simple_offers:
            print("\nğŸ“¦ Primeiros 3 produtos encontrados:")
            for i, product in enumerate(simple_offers[:3], 1):
                print(f"\n{i}. Produto encontrado:")
                print(f"   ğŸ’° PreÃ§o: R$ {product.get('price', 'N/A')}")
                print(f"   ğŸ’¸ ComissÃ£o: R$ {product.get('commission', 'N/A')}")
                print(f"   ğŸ“Š Taxa: {product.get('commissionRate', 'N/A')}%")
                print(
                    f"   ğŸ”— Link do Produto: {product.get('productLink', 'N/A')[:50]}..."
                )
                print(
                    f"   ğŸ¯ Link da Oferta: {product.get('offerLink', 'N/A')[:50]}..."
                )

        # Teste 2: Query com schema corrigido
        print("\nğŸ§ª TESTE 2: Query com Schema Corrigido")
        print("-" * 60)
        corrected_offers = api.get_product_offers(page=0, limit=10, sort_type=5)

        if corrected_offers:
            print("\nğŸ“¦ Primeiros 3 produtos encontrados:")
            for i, product in enumerate(corrected_offers[:3], 1):
                print(f"\n{i}. Produto encontrado:")
                print(f"   ğŸ’° PreÃ§o: R$ {product.get('price', 'N/A')}")
                print(f"   ğŸ’¸ ComissÃ£o: R$ {product.get('commission', 'N/A')}")
                print(f"   ğŸ“Š Taxa: {product.get('commissionRate', 'N/A')}%")
                print(f"   â­ AvaliaÃ§Ã£o: {product.get('ratingStar', 'N/A')}")
                print(f"   ğŸª Loja: {product.get('shopName', 'N/A')}")

        # Teste 3: InformaÃ§Ãµes do Schema
        print("\nğŸ§ª TESTE 3: InformaÃ§Ãµes do Schema")
        print("-" * 60)
        schema_info = api.get_schema_info()

        if schema_info:
            print("âœ… Schema obtido com sucesso!")
            print("ğŸ“‹ InformaÃ§Ãµes disponÃ­veis no schema")
        else:
            print("âš ï¸ NÃ£o foi possÃ­vel obter informaÃ§Ãµes do schema")

        print("\nğŸ‰ Todos os testes concluÃ­dos!")

    except Exception as e:
        print(f"âŒ Erro durante o teste: {e}")


if __name__ == "__main__":
    main()
